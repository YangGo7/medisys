# ğŸ”¥ NGINX Proxy - OHIF + Orthanc í†µí•© ì—°ë™ ì„¤ì •
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    
    # ğŸ”¥ ë¡œê·¸ ì„¤ì •
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;
    
    # ğŸ”¥ ì—…ìŠ¤íŠ¸ë¦¼ ì„œë²„ ì •ì˜
    upstream orthanc_backend {
        server 172.20.0.31:8042;  # orthanc ì»¨í…Œì´ë„ˆ
    }
    
    upstream ohif_frontend {
        server 172.20.0.60:80;    # ohif-viewer ì»¨í…Œì´ë„ˆ
    }
    
    # ğŸ”¥ ë©”ì¸ í”„ë¡ì‹œ ì„œë²„
    server {
        listen 80;
        server_name localhost;
        
        # ğŸ”¥ ê¸°ë³¸ ì„¤ì •
        client_max_body_size 100M;
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        
        # ğŸ”¥ CORS í—¤ë” ì¶”ê°€ í•¨ìˆ˜
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With, Accept, Origin, Cache-Control' always;
        add_header 'Access-Control-Max-Age' '86400' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;

        # ğŸ”¥ ë£¨íŠ¸ - OHIF Viewer
        location / {
            proxy_pass http://ohif_frontend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # OHIF ì •ì  íŒŒì¼ì„ ìœ„í•œ ìºì‹œ ì„¤ì •
            expires 1h;
        }

        # ğŸ”¥ Orthanc ë©”ì¸ API
        location /orthanc/ {
            # OPTIONS ìš”ì²­ ì²˜ë¦¬
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With, Accept, Origin' always;
                add_header 'Access-Control-Max-Age' '86400' always;
                add_header 'Content-Length' '0';
                add_header 'Content-Type' 'text/plain';
                return 204;
            }

            proxy_pass http://orthanc_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # ğŸ”¥ Basic Auth ì „ë‹¬
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
        }

        # ğŸ”¥ DICOMweb QIDO-RS/WADO-RS API
        location /dicom-web/ {
            # OPTIONS ìš”ì²­ ì²˜ë¦¬
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With, Accept, Origin' always;
                add_header 'Access-Control-Max-Age' '86400' always;
                add_header 'Content-Length' '0';
                add_header 'Content-Type' 'text/plain';
                return 204;
            }

            proxy_pass http://orthanc_backend/dicom-web/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # ğŸ”¥ DICOM íŠ¹í™” í—¤ë”
            proxy_set_header Accept "application/dicom+json, application/json, */*";
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
            
            # ğŸ”¥ DICOM ì´ë¯¸ì§€ëŠ” í´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ íƒ€ì„ì•„ì›ƒ ì—°ì¥
            proxy_read_timeout 600;
            proxy_send_timeout 600;
            proxy_buffering off;
        }

        # ğŸ”¥ WADO-URI API
        location /wado {
            # OPTIONS ìš”ì²­ ì²˜ë¦¬
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With, Accept, Origin' always;
                add_header 'Access-Control-Max-Age' '86400' always;
                add_header 'Content-Length' '0';
                add_header 'Content-Type' 'text/plain';
                return 204;
            }

            proxy_pass http://orthanc_backend/wado;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # ğŸ”¥ WADO ì¸ì¦
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
            
            # ğŸ”¥ ì´ë¯¸ì§€ ì „ì†¡ì„ ìœ„í•œ ì„¤ì •
            proxy_read_timeout 300;
            proxy_send_timeout 300;
        }

        # ğŸ”¥ Orthanc ì›¹ ì¸í„°í˜ì´ìŠ¤ (ê´€ë¦¬ìš©)
        location /app/ {
            proxy_pass http://orthanc_backend/app/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_set_header Authorization $http_authorization;
            proxy_pass_header Authorization;
        }

        # ğŸ”¥ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
        location /system {
            proxy_pass http://orthanc_backend/system;
            proxy_set_header Host $host;
            proxy_set_header Authorization $http_authorization;
        }

        # ğŸ”¥ Study/Series/Instance API
        location ~ ^/(studies|series|instances|patients)/ {
            proxy_pass http://orthanc_backend$request_uri;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Authorization $http_authorization;
            
            # í° DICOM íŒŒì¼ ì²˜ë¦¬
            proxy_read_timeout 600;
            proxy_buffering off;
        }

        # ğŸ”¥ ì—ëŸ¬ í˜ì´ì§€
        error_page 404 /404.html;
        error_page 500 502 503 504 /50x.html;
        
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}
