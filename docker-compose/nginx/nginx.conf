events {}

http {
  server {
    listen 80;

    ########## Django API Proxy ##########
    location /api/ {
      proxy_pass http://35.225.63.41:8000/api/;  # 또는 gunicorn/nginx container IP

      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # CORS Headers (optional)
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;

      if ($request_method = OPTIONS) {
        return 204;
      }
    }

    ########## DICOMWeb (for OHIF) ##########
    location /dicom-web/ {
      proxy_pass http://35.225.63.41:8042/dicom-web/;
      proxy_http_version 1.1;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Authorization "";

      proxy_connect_timeout 60s;
      proxy_send_timeout 60s;
      proxy_read_timeout 60s;
      send_timeout 60s;

      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;

      if ($request_method = OPTIONS) {
        return 204;
      }
    }

    ########## WADO URI support (legacy) ##########
    location /wado {
      proxy_pass http://orthanc:8042/wado;
      proxy_set_header Authorization "";
    }

    ########## OHIF Viewer (optional) ##########
    location /viewer/ {
      proxy_pass http://ohif-viewer:80/;
    }

    ########## Orthanc Web Viewer (optional) ##########
    location /app/ {
      proxy_pass http://orthanc:8042/app/;
    }
  }
}
