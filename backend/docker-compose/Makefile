# Orthanc AI Server Makefile

.PHONY: help build up down restart logs test clean install-deps

# ê¸°ë³¸ íƒ€ê²Ÿ
help:
	@echo "Orthanc AI Server ê´€ë¦¬ ëª…ë ¹ì–´:"
	@echo "  build       - Docker ì´ë¯¸ì§€ ë¹Œë“œ"
	@echo "  up          - ì»¨í…Œì´ë„ˆ ì‹œì‘"
	@echo "  down        - ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°"
	@echo "  restart     - ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘"
	@echo "  logs        - ì‹¤ì‹œê°„ ë¡œê·¸ ì¡°íšŒ"
	@echo "  test        - ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰"
	@echo "  clean       - ëª¨ë“  ì»¨í…Œì´ë„ˆ ë° ë³¼ë¥¨ ì œê±°"
	@echo "  install-deps- Python ì˜ì¡´ì„± ì„¤ì¹˜"
	@echo "  shell       - ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†"
	@echo "  status      - ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"

# Docker ì´ë¯¸ì§€ ë¹Œë“œ
build:
	@echo "ğŸ—ï¸ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
	docker-compose build --no-cache

# ì»¨í…Œì´ë„ˆ ì‹œì‘
up:
	@echo "ğŸš€ Orthanc AI Server ì‹œì‘ ì¤‘..."
	docker-compose up -d
	@echo "âœ… ì„œë²„ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤:"
	@echo "   - Web Interface: http://35.225.63.41:8042"
	@echo "   - DICOM Port: 4242"

# ì»¨í…Œì´ë„ˆ ì¤‘ì§€
down:
	@echo "ğŸ›‘ Orthanc AI Server ì¤‘ì§€ ì¤‘..."
	docker-compose down

# ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
restart: down up

# ì‹¤ì‹œê°„ ë¡œê·¸ ì¡°íšŒ
logs:
	@echo "ğŸ“‹ ì‹¤ì‹œê°„ ë¡œê·¸ ì¡°íšŒ (Ctrl+Cë¡œ ì¢…ë£Œ):"
	docker-compose logs -f

# AI ë¡œê·¸ë§Œ ì¡°íšŒ
ai-logs:
	@echo "ğŸ¤– AI ë¶„ì„ ë¡œê·¸ ì¡°íšŒ:"
	docker exec orthanc-ai-server tail -f /var/log/orthanc_ai.log

# ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
test:
	@echo "ğŸ§ª ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	python3 test_dicom_analysis.py

# ì˜ì¡´ì„± ì„¤ì¹˜ (ë¡œì»¬ ê°œë°œìš©)
install-deps:
	@echo "ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
	pip3 install -r requirements.txt

# ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†
shell:
	@echo "ğŸš ì»¨í…Œì´ë„ˆ ì‰˜ ì ‘ì†:"
	docker exec -it orthanc-ai-server /bin/bash

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
status:
	@echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:"
	@docker-compose ps
	@echo ""
	@echo "ğŸ” ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸:"
	@curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://35.225.63.41/:8042/system || echo "âŒ ì—°ê²° ì‹¤íŒ¨"

# ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ í™•ì¸
stats:
	@echo "ğŸ“ˆ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰:"
	docker stats orthanc-ai-server --no-stream

# ì „ì²´ ì •ë¦¬ (ì£¼ì˜: ëª¨ë“  ë°ì´í„° ì‚­ì œë¨)
clean:
	@echo "ğŸ§¹ ëª¨ë“  ì»¨í…Œì´ë„ˆ ë° ë³¼ë¥¨ ì œê±° ì¤‘..."
	@read -p "ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): " confirm && \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		docker-compose down -v --remove-orphans; \
		docker system prune -f; \
		echo "âœ… ì •ë¦¬ ì™„ë£Œ"; \
	else \
		echo "âŒ ì·¨ì†Œë¨"; \
	fi

# ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
setup:
	@echo "âš™ï¸ ì´ˆê¸° ì„¤ì • ì¤‘..."
	mkdir -p logs
	@if [ ! -f .env ]; then \
		cp .env.example .env; \
		echo "ğŸ“ .env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”ì— ë”°ë¼ ìˆ˜ì •í•˜ì„¸ìš”."; \
	fi
	@echo "âœ… ì´ˆê¸° ì„¤ì • ì™„ë£Œ"

# ê°œë°œ í™˜ê²½ ì„¤ì •
dev-setup: setup install-deps
	@echo "ğŸ› ï¸ ê°œë°œ í™˜ê²½ ì„¤ì • ì™„ë£Œ"

# ëª¨ë¸ ë‹¤ìš´ë¡œë“œ (ì˜ˆì‹œ)
download-models:
	@echo "ğŸ“¥ AI ëª¨ë¸ ë‹¤ìš´ë¡œë“œ ì¤‘..."
	@mkdir -p models/yolov8 models/ssd
	@echo "ğŸ’¡ ì»¤ìŠ¤í…€ ëª¨ë¸ì„ models/ ë””ë ‰í† ë¦¬ì— ë°°ì¹˜í•˜ì„¸ìš”:"
	@echo "   - models/yolov8/yolov8_best.pt"
	@echo "   - models/ssd/ssd_model/"

# ë°±ì—… ìƒì„±
backup:
	@echo "ğŸ’¾ ë°ì´í„° ë°±ì—… ìƒì„± ì¤‘..."
	@timestamp=$$(date +%Y%m%d_%H%M%S); \
	docker run --rm -v orthanc-ai-server_orthanc_data:/data -v $$(pwd)/backups:/backup alpine tar czf /backup/orthanc_backup_$$timestamp.tar.gz -C /data .; \
	echo "âœ… ë°±ì—… ì™„ë£Œ: backups/orthanc_backup_$$timestamp.tar.gz"

# ë°±ì—… ë³µì›
restore:
	@echo "â™»ï¸ ë°ì´í„° ë³µì›:"
	@ls -la backups/*.tar.gz 2>/dev/null || (echo "âŒ ë°±ì—… íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤." && exit 1)
	@read -p "ë³µì›í•  ë°±ì—… íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”: " backup_file; \
	if [ -f "backups/$$backup_file" ]; then \
		docker-compose down; \
		docker run --rm -v orthanc-ai-server_orthanc_data:/data -v $$(pwd)/backups:/backup alpine sh -c "cd /data && tar xzf /backup/$$backup_file"; \
		echo "âœ… ë³µì› ì™„ë£Œ"; \
	else \
		echo "âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: backups/$$backup_file"; \
	fi

# ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ (ê°„ë‹¨í•œ ìƒíƒœ í™•ì¸)
monitor:
	@echo "ğŸ“Š ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ (Ctrl+Cë¡œ ì¢…ë£Œ):"
	@while true; do \
		clear; \
		echo "=== Orthanc AI Server ëª¨ë‹ˆí„°ë§ ==="; \
		echo "ì‹œê°„: $$(date)"; \
		echo ""; \
		echo "ì»¨í…Œì´ë„ˆ ìƒíƒœ:"; \
		docker-compose ps; \
		echo ""; \
		echo "ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰:"; \
		docker stats orthanc-ai-server --no-stream; \
		echo ""; \
		echo "ìµœê·¼ ë¡œê·¸ (ë§ˆì§€ë§‰ 5ì¤„):"; \
		docker-compose logs --tail=5 orthanc; \
		sleep 5; \
	done